
Aggregates differ from comprehensions in two major ways: (1) the aggregate needs to
collect one value per application and (2) the aggregate needs to derive a second
head where the aggregated value is instantiated. However, the proof of
correctness for aggregates does not differ significantly from before. The
soundness of matching and derivation needs to be proved in order to prove that
the whole process derives $n$ aggregate applications with $n$ aggregated values.

\begin{lemma}[Aggregate body match]\label{thm:aggregate_body_match}
Given an aggregate $AG = \aggsz{A}{B}{C}$, consider a triplet $T = A; \Gamma;
\Delta_{N}$ and a context $\Delta_{N} = \Delta_1, \Delta_2, \Xi$.

If $\ma \Gamma; \Delta_1, \Delta_2; \Xi_N; \Gamma_{N1}; \Delta_{N1}; \Xi;
\Omega; C; P; AG; \Omega_N; \Delta_N; \Sigma \rightarrow \outsem$ is well-formed in relation to $T$ then either:

   \begin{itemize}[leftmargin=*]
      \item Match fails:
      \begin{itemize}[leftmargin=\secondm]
         \item $\done \Gamma; \Delta_N; \Xi_N; \Gamma_{N1}; \Delta_{N1}; \Omega_N \rightarrow \outsem$
      \end{itemize}
      
      \item Match succeeds with no backtracking to frames of stack $C$ or $P$
      ($C \neq \cdot$):

      \begin{itemize}[leftmargin=\secondm]
         \item $\mz \Gamma; \Delta_2 \rightarrow A$
         \item $\mc \Gamma; \Delta_1; \Xi_N; \Gamma_{N1}; \Delta_{N1}; \Xi,
            \Delta_2; \cdot; C', C; P; AB; \Omega_N; \Delta_N
            \rightarrow \outsem$ (well-formed in relation to
                  $T$)
      \end{itemize}

      \item Match succeeds with no backtracking to frames of stack $P$ ($C =
            \cdot$):
      \begin{itemize}[leftmargin=\secondm]
         \item $\mz \Gamma; \Delta_2 \rightarrow A$
         \item $\mc \Gamma; \Delta_1; \Xi_N; \Gamma_{N1}; \Delta_{N1}; \Xi,
            \Delta_2; \cdot; C'; P', P; AB; \Omega_N; \Delta_N
            \rightarrow \outsem$ (well-formed in relation to
                  $T$)
      \end{itemize}

      \item Match succeeds with backtracking to a linear continuation frame in
      stack $C$ ($C \neq \cdot$):

      \begin{itemize}[leftmargin=\secondm]
         \item $\mz \Gamma; \Xi_1, \dotsc, \Xi_m, p_2, \Xi_c$
         \item $\exists_{f \in C}. f = (\Delta_a; \Delta_{b_1}, p_2,
               \Delta_{b_2}; p; \Xi_1, \dotsc, \Xi_m; \Omega_1, \dotsc,
               \Omega_k; \Lambda_1, \dotsc, \Lambda_m; \Upsilon_1, \dotsc,
               \Upsilon_n)$
         \item $C = C', f, C''$
         \item $f$ turns into $f' = (\Delta_a, \Delta_{b_1}, p_2;
               \Delta_{b_2}; p; \Xi_1, \dotsc, \Xi_m;
               \Omega_1, \dotsc, \Omega_k; \Lambda_1, \dotsc, \Lambda_m;
               \Upsilon_1, \dotsc, \Upsilon_n)$
         \item $\mc \Gamma; \Delta_c; \Xi_N; \Gamma_{N1}; \Delta_{N1}; \Xi_1,
            \dotsc, \Xi_m, p_2, \Xi_c; \cdot; C''', f', C''; P;
            AB; \Omega_N; \Delta_N \rightarrow \outsem$ (well-formed in relation to $T$)
         \item $\Delta_c = (\Delta_1, \Delta_2, \Xi) - (\Xi_1, \dotsc, \Xi_m,
               p_2, \Xi_c)$
      \end{itemize}

      \item Match succeeds with backtracking to a persistent continuation frame
      in stack $C$ ($C \neq \cdot$):
      \begin{itemize}[leftmargin=\secondm]
         \item $\mz \Gamma; \Delta_{c_2}, \Xi_1, \dotsc, \Xi_m \rightarrow A$
         \item $\exists_{f \in C}. f = [\Gamma_1, p_2, \Gamma_2; \Delta_{c_1},
            \Delta_{c_2}; \Xi_1, \dotsc, \Xi_m; \bang p; \Omega_1, \dotsc, \Omega_k;
            \Lambda_1, \dotsc, \Lambda_m; \Upsilon_1, \dotsc, \Upsilon_n]$
         \item $C = C', f, C''$
         \item $f$ turns into $f' = [\Gamma_2; \Delta_{c_1}, \Delta_{c_2};
            \Xi_1, \dotsc, \Xi_m; \bang p; \Omega_1, \dotsc, \Omega_k; \Lambda_1,
            \dotsc, \Lambda_m; \Upsilon_1, \dotsc, \Upsilon_n]$
         \item $\mc \Gamma; \Delta_{c_1}; \Xi_N; \Gamma_{N1}; \Delta_{N1};
            \Delta_{c_2}, \Xi_1, \dotsc, \Xi_m; \cdot; C''', f', C''; P;
            AB; \Omega_N; \Delta_N \rightarrow \outsem$ (well-formed in relation to $T$)
         \item $\Delta_{c_1}, \Delta_{c_2} = (\Delta_1, \Delta_2, \Xi) - (\Xi_1, \dotsc, \Xi_m)$
      \end{itemize}

      \item Match succeeds with backtracking to a persistent continuation frame
      in stack $P$ ($C = \cdot$):
      \begin{itemize}[leftmargin=\secondm]
         \item $\mz \Gamma; \Delta_{c_2}, \Xi_1, \dotsc, \Xi_m \rightarrow A$
         \item $\exists_{f \in P}. f = [\Gamma_1, p_2, \Gamma_2; \Delta_{c_1}, \Delta_{c_2};
      \Xi_1, \dotsc, \Xi_m; \bang p; \Omega_1, \dotsc, \Omega_k; \Lambda_1,
      \dotsc, \Lambda_m; \Upsilon_1, \dotsc, \Upsilon_n]$
         \item $P = P', f, P''$
         \item $f$ turns into $f' = [\Gamma_2; \Delta_{c_1},
            \Delta_{c_2}; \Xi_1, \dotsc, \Xi_m; \bang p; \Omega_1, \dotsc,
            \Omega_k; \Lambda_1, \dotsc, \Lambda_m; \Upsilon_1, \dotsc, \Upsilon_n]$
         \item $\mc \Gamma; \Delta_{c_1}; \Xi_N; \Gamma_{N1}; \Delta_{N1};
         \Delta_{c_2}, \Xi_1, \dotsc, \Xi_m; \cdot; C'; P''', f', P'';
         AB; \Omega_N; \Delta_N \rightarrow \outsem$
         (well-formed in relation to $T$)
         \item $\Delta_{c_1}, \Delta_{c_2} = (\Delta_1, \Delta_2, \Xi) - (\Xi_1, \dotsc,
               \Xi_m)$
      \end{itemize}
   \end{itemize}
   
If $\contc \Gamma; \Delta_{N}; \Xi_{N}; \Gamma_{N1}; \Delta_{N1}; C; P;
AB; \Omega_N \rightarrow \outsem$ and $C$ and $P$ are
well-formed in relation to $T$ then either:

\begin{itemize}[leftmargin=*]
   \item Match fails:
   \begin{itemize}[leftmargin=\secondm]
      \item $\done \Gamma; \Delta_N; \Xi_N; \Gamma_{N1}; \Delta_{N1}; \Omega_N \rightarrow \outsem$
   \end{itemize}

   \item Match succeeds with backtracking to a linear continuation frame in
   stack $C$ ($C \neq \cdot$):

   \item Match succeeds: $\mz \Gamma; \Delta_x \rightarrow A$ (where
         $\Delta_x \subseteq \Delta_N$) and either:
   \begin{itemize}[leftmargin=\secondm]
      \item $\mz \Gamma; \Xi_1, \dotsc, \Xi_m, p_2, \Xi_c$
      \item $\exists_{f \in C}. f = (\Delta_a; \Delta_{b_1}, p_2,
            \Delta_{b_2}; p; \Xi_1, \dotsc, \Xi_m; \Omega_1, \dotsc,
            \Omega_k; \Lambda_1, \dotsc, \Lambda_m; \Upsilon_1, \dotsc,
            \Upsilon_n)$
      \item $C = C', f, C''$
      \item $f$ turns into $f' = (\Delta_a, \Delta_{b_1}, p_2;
            \Delta_{b_2}; p; \Xi_1, \dotsc, \Xi_m;
            \Omega_1, \dotsc, \Omega_k; \Lambda_1, \dotsc, \Lambda_m;
            \Upsilon_1, \dotsc, \Upsilon_n)$
      \item $\mc \Gamma; \Delta_c; \Xi_N; \Gamma_{N1}; \Delta_{N1}; \Xi_1,
         \dotsc, \Xi_m, p_2, \Xi_c; \cdot; C''', f', C''; P;
         AB; \Omega_N; \Delta_N \rightarrow \outsem$ (well-formed in relation to $T$)
      \item $\Delta_c = (\Delta_1, \Delta_2, \Xi) - (\Xi_1, \dotsc, \Xi_m,
            p_2, \Xi_c)$
   \end{itemize}

   \item Match succeeds with backtracking to a persistent continuation frame
   in stack $C$ ($C \neq \cdot$):
   \begin{itemize}[leftmargin=\secondm]
      \item $\mz \Gamma; \Delta_{c_2}, \Xi_1, \dotsc, \Xi_m \rightarrow A$
      \item $\exists_{f \in C}. f = [\Gamma_1, p_2, \Gamma_2; \Delta_{c_1},
         \Delta_{c_2}; \Xi_1, \dotsc, \Xi_m; \bang p; \Omega_1, \dotsc, \Omega_k;
         \Lambda_1, \dotsc, \Lambda_m; \Upsilon_1, \dotsc, \Upsilon_n]$
      \item $C = C', f, C''$
      \item $f$ turns into $f' = [\Gamma_2; \Delta_{c_1}, \Delta_{c_2};
         \Xi_1, \dotsc, \Xi_m; \bang p; \Omega_1, \dotsc, \Omega_k; \Lambda_1,
         \dotsc, \Lambda_m; \Upsilon_1, \dotsc, \Upsilon_n]$
      \item $\mc \Gamma; \Delta_{c_1}; \Xi_N; \Gamma_{N1}; \Delta_{N1};
         \Delta_{c_2}, \Xi_1, \dotsc, \Xi_m; \cdot; C''', f', C''; P;
         AB; \Omega_N; \Delta_N \rightarrow \outsem$ (well-formed in relation to $T$)
      \item $\Delta_{c_1}, \Delta_{c_2} = (\Delta_1, \Delta_2, \Xi) - (\Xi_1, \dotsc, \Xi_m)$
   \end{itemize}

   \item Match succeeds with backtracking to a persistent continuation frame
   in stack $P$ ($C = \cdot$):
   \begin{itemize}[leftmargin=\secondm]
      \item $\mz \Gamma; \Delta_{c_2}, \Xi_1, \dotsc, \Xi_m \rightarrow A$
      \item $\exists_{f \in P}. f = [\Gamma_1, p_2, \Gamma_2; \Delta_{c_1}, \Delta_{c_2};
   \Xi_1, \dotsc, \Xi_m; \bang p; \Omega_1, \dotsc, \Omega_k; \Lambda_1,
   \dotsc, \Lambda_m; \Upsilon_1, \dotsc, \Upsilon_n]$
      \item $P = P', f, P''$
      \item $f$ turns into $f' = [\Gamma_2; \Delta_{c_1},
         \Delta_{c_2}; \Xi_1, \dotsc, \Xi_m; \bang p; \Omega_1, \dotsc,
         \Omega_k; \Lambda_1, \dotsc, \Lambda_m; \Upsilon_1, \dotsc, \Upsilon_n]$
      \item $\mc \Gamma; \Delta_{c_1}; \Xi_N; \Gamma_{N1}; \Delta_{N1};
      \Delta_{c_2}, \Xi_1, \dotsc, \Xi_m; \cdot; C'; P''', f', P'';
      AB; \Omega_N; \Delta_N \rightarrow \outsem$
      (well-formed in relation to $T$)
      \item $\Delta_{c_1}, \Delta_{c_2} = (\Delta_1, \Delta_2, \Xi) - (\Xi_1, \dotsc,
            \Xi_m)$
   \end{itemize}
   
\end{itemize}
\end{lemma}
